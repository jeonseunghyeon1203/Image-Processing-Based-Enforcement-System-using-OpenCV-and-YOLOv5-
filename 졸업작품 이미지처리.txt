from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
import time
import os
import shutil
import subprocess
import easyocr
from pathlib import Path
import cv2

WATCH_FOLDER = os.path.expanduser("~/Desktop")
TARGET_FILENAME = "captured.jpg"
SAVE_FOLDER = os.path.join(WATCH_FOLDER, "plate_results")
os.makedirs(SAVE_FOLDER, exist_ok=True)

YOLOV5_DIR = r"C:\Users\Hi\Downloads\yolov5"  # YOLOv5 Í≤ΩÎ°ú
WEIGHTS_PATH = r"runs/train/exp3/weights/best.pt"  # ÌõàÎ†®Îêú Î™®Îç∏
OUTPUT_PROJECT = "runs/detect"
OUTPUT_NAME = "live_detect"

class MyHandler(FileSystemEventHandler):
    def __init__(self):
        self.last_processed = 0
        self.counter = 1

    def on_modified(self, event):
        if os.path.basename(event.src_path) == TARGET_FILENAME:
            now = time.time()
            if now - self.last_processed < 3:
                return

            # ÌååÏùº ÏïàÏ†ïÌôî ÌôïÏù∏
            prev_size = -1
            while True:
                if not os.path.exists(event.src_path):
                    print("‚ùå ÌååÏùºÏù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏùå")
                    return
                curr_size = os.path.getsize(event.src_path)
                if curr_size == prev_size:
                    break
                prev_size = curr_size
                time.sleep(0.5)

            self.last_processed = now
            print(f"\nüì∏ ÏÉà Ïù¥ÎØ∏ÏßÄ Í∞êÏßÄÎê®: {TARGET_FILENAME}")
            self.process_image(event.src_path)

    def process_image(self, filepath):
        # YOLOv5 Í≤ÄÏ∂ú Ïã§Ìñâ
        self.run_yolov5_detect(filepath)

        # YOLOv5 Í≤∞Í≥º Ìè¥ÎçîÏóêÏÑú ÏûòÎùºÎÇ∏ Î≤àÌò∏Ìåê Ïù¥ÎØ∏ÏßÄ Î≥µÏÇ¨
        crops_dir = Path(YOLOV5_DIR) / OUTPUT_PROJECT / OUTPUT_NAME / "crops"
        if crops_dir.exists():
            found_plate = False
            for class_dir in crops_dir.iterdir():
                if class_dir.is_dir():
                    for img_file in class_dir.iterdir():
                        filename = f"final_plate_{self.counter}.jpg"
                        dst = Path(SAVE_FOLDER) / filename
                        shutil.copy(img_file, dst)
                        print(f"‚úÖ Î≤àÌò∏Ìåê ÏòÅÏó≠ Ï†ÄÏû•: {filename}")
                        self.run_ocr(str(dst))
                        found_plate = True
            if not found_plate:
                print("‚ùå Î≤àÌò∏ÌåêÏù¥ Í≤ÄÏ∂úÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.")
        else:
            print("‚ùå YOLOv5 crops ÎîîÎ†âÌÜ†Î¶¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.")

        # YOLO Í≤∞Í≥º ÎîîÎ†âÌÜ†Î¶¨ Ï†ïÎ¶¨
        shutil.rmtree(Path(YOLOV5_DIR) / OUTPUT_PROJECT / OUTPUT_NAME, ignore_errors=True)
        self.counter += 1

        # ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú
        try:
            os.remove(filepath)
            print(f"üóëÔ∏è ÏõêÎ≥∏ ÌååÏùº ÏÇ≠Ï†ú ÏôÑÎ£å")
        except Exception as e:
            print(f"‚ùå ÏõêÎ≥∏ ÌååÏùº ÏÇ≠Ï†ú Ïã§Ìå®: {e}")

    def run_yolov5_detect(self, image_path):
        os.chdir(YOLOV5_DIR)
        command = [
            "python", "detect.py",
            "--weights", WEIGHTS_PATH,
            "--source", image_path,
            "--img", "640",
            "--save-crop",
            "--project", OUTPUT_PROJECT,
            "--name", OUTPUT_NAME
        ]
        print("üöÄ YOLOv5 Î≤àÌò∏Ìåê Í≤ÄÏ∂ú Ïã§Ìñâ Ï§ë...")
        subprocess.run(command, stdout=subprocess.DEVNULL)

    def run_ocr(self, plate_path):
        reader = easyocr.Reader(['ko'])
        results = reader.readtext(plate_path)
        results_sorted = sorted(results, key=lambda x: (x[0][0][0], x[0][0][1]))
        full_text = ''.join([text for _, text, _ in results_sorted])

        timestamp = time.strftime("%Y-%m-%d %H:%M:%S")
        log_line = f"[{timestamp}] Ïù∏Ïãù Í≤∞Í≥º: {full_text}\n"

        txt_path = os.path.join(SAVE_FOLDER, "results.txt")
        with open(txt_path, "a", encoding="utf-8") as f:
            f.write(log_line)

        print(f"üî† {log_line.strip()}")

if __name__ == "__main__":
    print(f"üìÇ Í∞êÏãú Ï§ë: '{TARGET_FILENAME}' in {WATCH_FOLDER}")
    print("üìå Ctrl+CÎ°ú Ï¢ÖÎ£å Í∞ÄÎä•")
    event_handler = MyHandler()
    observer = Observer()
    observer.schedule(event_handler, path=WATCH_FOLDER, recursive=False)
    observer.start()
    try:
        while True:
            time.sleep(1)
    except KeyboardIn